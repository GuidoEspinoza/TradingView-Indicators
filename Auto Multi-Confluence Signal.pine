//@version=6
indicator("Auto Multi-Confluence Signal", overlay=true, max_labels_count=500)

// ==================== INPUTS ====================
// Divergence Settings
rsiLength = input.int(14, "RSI Length", group="Divergence")
macdFast = input.int(12, "MACD Fast", group="Divergence")
macdSlow = input.int(26, "MACD Slow", group="Divergence")
macdSignal = input.int(9, "MACD Signal", group="Divergence")
pivotLookback = input.int(5, "Pivot Lookback", group="Divergence")

// Trend Settings
trendMA1 = input.int(20, "Fast MA", group="Trend")
trendMA2 = input.int(50, "Slow MA", group="Trend")
maType = input.string("EMA", "MA Type", options=["SMA", "EMA"], group="Trend")
atrLen = input.int(14, "ATR Length", group="Trend")

// Momentum Settings
momentumLength = input.int(14, "Momentum Period", group="Momentum")

// Volume Settings
volumeMA = input.int(20, "Volume MA Length", group="Volume")

// Ichimoku Settings
conversionPeriods = input.int(9, "Conversion Line", group="Ichimoku")
basePeriods = input.int(26, "Base Line", group="Ichimoku")
laggingSpan2Periods = input.int(52, "Leading Span B", group="Ichimoku")
displacement = input.int(26, "Displacement", group="Ichimoku")

// Signal Settings
confluenceRequired = input.int(3, "Min Confluence (out of 6)", minval=1, maxval=6, group="Signals")
signalMaxAge = input.int(3, "Max Bars Since Base", minval=1, group="Signals")
showDivergence = input.bool(true, "Show Divergence", group="Signals")
showTrendShift = input.bool(true, "Show Trend Shifts", group="Signals")
showTable = input.bool(true, "Show Indicator Table", group="Display")
showParamsInTable = input.bool(false, "Show Effective Params", group="Display")
showCloud = input.bool(false, "Show Ichimoku Cloud", group="Display")
showExecute = input.bool(true, "Show Execute", group="Signals")
executeMaxBars = input.int(2, "Max Bars To Execute", minval=1, group="Signals")
requireExecTrendStrength = input.bool(true, "Execute Requires Trend Strength", group="Signals")
execTrendStrengthMin = input.float(0.6, "Trend Strength Min (ATR-norm)", step=0.1, group="Signals")
execMaxDistATR = input.float(0.8, "Max Distance to EMA1 (ATR)", step=0.1, group="Signals")
requireExecCloud = input.bool(false, "Execute Requires Cloud Alignment", group="Signals")
requireExecDoubleHist = input.bool(true, "Execute Requires 2 Hist Bars", group="Signals")

// Timeframe Settings
useCurrentRes = input.bool(true, "Use Current Chart Resolution?", group="Timeframe")
resCustom = input.string("60", "Use Different Timeframe", options=["1","5","15","30","60","240"], group="Timeframe")
useAutoParams = input.bool(true, "Auto-Adjust Parameters by Timeframe", group="Timeframe")
tf = useCurrentRes ? timeframe.period : resCustom
tfSec = timeframe.in_seconds(tf)
is1 = tfSec == 60
is3 = tfSec == 180  // 3 minutes support added
is5 = tfSec == 300
is15 = tfSec == 900
is30 = tfSec == 1800
is60 = tfSec == 3600
is240 = tfSec == 14400
lowTF = is1 or is3 or is5

// Effective parameters per timeframe
rsiLenEff = useAutoParams ? (is1 ? 8 : is3 ? 10 : is5 ? 12 : is15 ? 14 : is30 ? 14 : is60 ? 14 : is240 ? 14 : rsiLength) : rsiLength
macdFastEff = useAutoParams ? (is1 ? 6 : is3 ? 7 : is5 ? 8 : is15 ? 12 : is30 ? 12 : is60 ? 12 : is240 ? 12 : macdFast) : macdFast
macdSlowEff = useAutoParams ? (is1 ? 13 : is3 ? 17 : is5 ? 20 : is15 ? 26 : is30 ? 26 : is60 ? 26 : is240 ? 26 : macdSlow) : macdSlow
macdSignalEff = useAutoParams ? (is1 ? 4 : is3 ? 5 : is5 ? 6 : is15 ? 9 : is30 ? 9 : is60 ? 9 : is240 ? 9 : macdSignal) : macdSignal
trendMA1Eff = useAutoParams ? (is1 ? 9 : is3 ? 12 : is5 ? 18 : is15 ? 20 : is30 ? 20 : is60 ? 50 : is240 ? 50 : trendMA1) : trendMA1
trendMA2Eff = useAutoParams ? (is1 ? 24 : is3 ? 30 : is5 ? 50 : is15 ? 100 : is30 ? 100 : is60 ? 200 : is240 ? 200 : trendMA2) : trendMA2
momentumLengthEff = useAutoParams ? (is1 ? 7 : is3 ? 9 : is5 ? 12 : is15 ? 14 : is30 ? 20 : is60 ? 20 : is240 ? 21 : momentumLength) : momentumLength
volumeMAEff = useAutoParams ? (is1 ? 32 : is3 ? 35 : is5 ? 40 : is15 ? 50 : is30 ? 60 : is60 ? 70 : is240 ? 100 : volumeMA) : volumeMA
confluenceEff = lowTF ? (is1 ? 2 : is3 ? 3 : is5 ? 3 : 3) : confluenceRequired
signalMaxAgeEff = lowTF ? (is1 ? 3 : is3 ? 3 : is5 ? 3 : 2) : signalMaxAge
execTSMinEff = is1 ? 0.7 : is3 ? 0.65 : is5 ? 0.6 : 0.5
execDistATREff = is1 ? 0.6 : is3 ? 0.7 : is5 ? 0.8 : 1.0
executeMaxBarsEff = lowTF ? 2 : executeMaxBars
conversionEff = conversionPeriods
baseEff = basePeriods
laggingEff = laggingSpan2Periods
displacementEff = displacement

// Low timeframe RSI thresholds
tfIsLow = is1 or is3 or is5
rsiOSEff = tfIsLow ? (is1 ? 20 : is3 ? 22 : 25) : 30
rsiOBEff = tfIsLow ? (is1 ? 80 : is3 ? 78 : 75) : 70

// ==================== INDICATORS ====================

// Moving Averages
// ==================== CORRECCIÓN ANTI-REPAINTING ====================
srcO = request.security(syminfo.tickerid, tf, open, barmerge.gaps_off, barmerge.lookahead_off)
srcH = request.security(syminfo.tickerid, tf, high, barmerge.gaps_off, barmerge.lookahead_off)
srcL = request.security(syminfo.tickerid, tf, low, barmerge.gaps_off, barmerge.lookahead_off)
srcC = request.security(syminfo.tickerid, tf, close, barmerge.gaps_off, barmerge.lookahead_off)
srcV = request.security(syminfo.tickerid, tf, volume, barmerge.gaps_off, barmerge.lookahead_off)
atrValue = request.security(syminfo.tickerid, tf, ta.atr(atrLen), barmerge.gaps_off, barmerge.lookahead_off)
ma1 = maType == "EMA" ? ta.ema(srcC, trendMA1Eff) : ta.sma(srcC, trendMA1Eff)
ma2 = maType == "EMA" ? ta.ema(srcC, trendMA2Eff) : ta.sma(srcC, trendMA2Eff)

// RSI
rsi = ta.rsi(srcC, rsiLenEff)

// MACD
[macdLine, signalLine, macdHist] = ta.macd(srcC, macdFastEff, macdSlowEff, macdSignalEff)

// Momentum
momentum = ta.mom(srcC, momentumLengthEff)

// Volume
volMA = ta.sma(srcV, volumeMAEff)
volumeStrength = srcV > volMA
trendStrength = math.abs(ma1 - ma2) / atrValue

// Ichimoku Cloud
donchian(len) => math.avg(ta.lowest(srcL, len), ta.highest(srcH, len))
conversionLine = donchian(conversionEff)
baseLine = donchian(baseEff)
leadSpanA = math.avg(conversionLine, baseLine)
leadSpanB = donchian(laggingEff)

// ==================== DIVERGENCE DETECTION ====================

// Pivot Points
pivotHigh = ta.pivothigh(srcH, pivotLookback, pivotLookback)
pivotLow = ta.pivotlow(srcL, pivotLookback, pivotLookback)

// Store pivot values
var float lastPivotHigh = na
var int lastPivotHighBar = na
var float lastPivotLow = na
var int lastPivotLowBar = na

if not na(pivotHigh)
    lastPivotHigh := high[pivotLookback]
    lastPivotHighBar := bar_index - pivotLookback

if not na(pivotLow)
    lastPivotLow := low[pivotLookback]
    lastPivotLowBar := bar_index - pivotLookback

// Store RSI values at pivots
var float lastPivotHighRSI = na
var float lastPivotLowRSI = na

if not na(pivotHigh)
    lastPivotHighRSI := rsi[pivotLookback]

if not na(pivotLow)
    lastPivotLowRSI := rsi[pivotLookback]

// Bullish Divergence (Higher Low in RSI, Lower Low in Price)
bullishDiv = false
if not na(pivotLow) and not na(lastPivotLow) and not na(lastPivotLowRSI)
    priceLowerLow = low[pivotLookback] < lastPivotLow
    rsiHigherLow = rsi[pivotLookback] > lastPivotLowRSI
    bullishDiv := priceLowerLow and rsiHigherLow

// Bearish Divergence (Lower High in RSI, Higher High in Price)
bearishDiv = false
if not na(pivotHigh) and not na(lastPivotHigh) and not na(lastPivotHighRSI)
    priceHigherHigh = high[pivotLookback] > lastPivotHigh
    rsiLowerHigh = rsi[pivotLookback] < lastPivotHighRSI
    bearishDiv := priceHigherHigh and rsiLowerHigh

// ==================== TREND ANALYSIS ====================

// Macro Trend (Higher timeframe concept - using slower MA)
// Simplified: Use ma2 position relative to its own average for macro trend
macroTrendBullish = ma2 > ta.ema(ma2, 100)

// Current Timeframe Trend
currentTrendBullish = srcC > ma1 and ma1 > ma2

// Trend Shift Detection
bullishTrendShift = ta.crossover(ma1, ma2)
bearishTrendShift = ta.crossunder(ma1, ma2)

// ==================== MOMENTUM ====================
momentumBullish = momentum > 0 and momentum > momentum[1]

// ==================== MARKET STRUCTURE ====================
// Simple structure: Higher highs and higher lows = bullish
structureBullish = high > high[5] and low > low[5]

// ==================== OVERBOUGHT/OVERSOLD ====================
overbought = rsi > rsiOBEff
oversold = rsi < rsiOSEff
neutral = not overbought and not oversold

// ==================== VOLUME AND ORDER FLOW ====================
volumeBullish = srcV > volMA and srcC > srcO

// ==================== CONFLUENCE SCORING ====================
bullishScore = 0
bearishScore = 0

// Score each indicator
bullishScore += currentTrendBullish ? 1 : 0
bullishScore += momentumBullish ? 1 : 0
bullishScore += structureBullish ? 1 : 0
bullishScore += volumeBullish ? 1 : 0
bullishScore += srcC > leadSpanA and srcC > leadSpanB ? 1 : 0
bullishScore += macdHist > 0 ? 1 : 0

bearishScore += not currentTrendBullish ? 1 : 0
bearishScore += not momentumBullish ? 1 : 0
bearishScore += not structureBullish ? 1 : 0
bearishScore += not volumeBullish ? 1 : 0
bearishScore += srcC < leadSpanA and srcC < leadSpanB ? 1 : 0
bearishScore += macdHist < 0 ? 1 : 0

// ==================== SIGNAL GENERATION ====================

rsiCrossOver30 = ta.crossover(rsi, 30)
rsiCrossUnder70 = ta.crossunder(rsi, 70)

var int lastBullBaseBar = na
var int lastBearBaseBar = na
bullBase = bullishDiv or bullishTrendShift or (oversold and rsiCrossOver30)
bearBase = bearishDiv or bearishTrendShift or (overbought and rsiCrossUnder70)
if bullBase
    lastBullBaseBar := bar_index
if bearBase
    lastBearBaseBar := bar_index
freshBull = not na(lastBullBaseBar) and (bar_index - lastBullBaseBar) <= signalMaxAgeEff
freshBear = not na(lastBearBaseBar) and (bar_index - lastBearBaseBar) <= signalMaxAgeEff

// Buy Signal: Bullish divergence + confluence + oversold
strongBull = bullishTrendShift and macdHist > 0 and momentumBullish
strongBear = bearishTrendShift and macdHist < 0 and not momentumBullish

buySignal = bullishDiv and bullishScore >= confluenceEff
buySignal := buySignal or (bullishTrendShift and bullishScore >= confluenceEff)
buySignal := buySignal or (strongBull and bullishScore >= (confluenceEff - 1))
buySignal := buySignal or (oversold and rsiCrossOver30 and bullishScore >= confluenceEff)
buySignal := buySignal and freshBull
buySignal := buySignal and (is1 and not strongBull ? (currentTrendBullish and momentumBullish) : true)
buySignal := buySignal and (lowTF and not strongBull ? macdHist > 0 : true)

// Sell Signal: Bearish divergence + confluence + overbought  
sellSignal = bearishDiv and bearishScore >= confluenceEff
sellSignal := sellSignal or (bearishTrendShift and bearishScore >= confluenceEff)
sellSignal := sellSignal or (strongBear and bearishScore >= (confluenceEff - 1))
sellSignal := sellSignal or (overbought and rsiCrossUnder70 and bearishScore >= confluenceEff)
sellSignal := sellSignal and freshBear
sellSignal := sellSignal and (is1 and not strongBear ? (not currentTrendBullish and not momentumBullish) : true)
sellSignal := sellSignal and (lowTF and not strongBear ? macdHist < 0 : true)

var int lastBuySignalBar = na
var float lastBuySignalHigh = na
var int lastSellSignalBar = na
var float lastSellSignalLow = na
if buySignal
    lastBuySignalBar := bar_index
    lastBuySignalHigh := srcH
if sellSignal
    lastSellSignalBar := bar_index
    lastSellSignalLow := srcL
buyExecAgeOK = not na(lastBuySignalBar) and (bar_index - lastBuySignalBar) <= executeMaxBarsEff
sellExecAgeOK = not na(lastSellSignalBar) and (bar_index - lastSellSignalBar) <= executeMaxBarsEff
execBuyTrig = ta.crossover(srcC, lastBuySignalHigh)
execSellTrig = ta.crossunder(srcC, lastSellSignalLow)
distFromMa1 = math.abs(srcC - ma1)
tsOK = not requireExecTrendStrength or trendStrength >= execTSMinEff
distOK = distFromMa1 <= execDistATREff * atrValue
cloudOKBuy = not requireExecCloud or (srcC > leadSpanA and srcC > leadSpanB)
cloudOKSell = not requireExecCloud or (srcC < leadSpanA and srcC < leadSpanB)
histUp2 = macdHist >= macdHist[1] and macdHist[1] >= macdHist[2]
histDown2 = macdHist <= macdHist[1] and macdHist[1] <= macdHist[2]
histOKBuy = not requireExecDoubleHist or histUp2
histOKSell = not requireExecDoubleHist or histDown2
executeBuy = showExecute and buyExecAgeOK and execBuyTrig and cloudOKBuy and histOKBuy and (lowTF ? (macdHist > 0 and currentTrendBullish and momentumBullish and tsOK and distOK) : true)
executeSell = showExecute and sellExecAgeOK and execSellTrig and cloudOKSell and histOKSell and (lowTF ? (macdHist < 0 and not currentTrendBullish and not momentumBullish and tsOK and distOK) : true)

// ==================== PLOTTING ====================

// Ichimoku Cloud
p1 = plot(showCloud ? leadSpanA : na, offset=displacement, color=color.new(color.green, 70), title="Lead Span A")
p2 = plot(showCloud ? leadSpanB : na, offset=displacement, color=color.new(color.red, 70), title="Lead Span B")
fill(p1, p2, color=leadSpanA > leadSpanB ? color.new(color.green, 90) : color.new(color.red, 90))

// Moving Averages
plot(ma1, "Fast MA", color=color.new(color.blue, 0), linewidth=2)
plot(ma2, "Slow MA", color=color.new(color.orange, 0), linewidth=2)

// Buy/Sell Signals
plotshape(buySignal, "Buy Signal", shape.labelup, location.belowbar, color.new(color.green, 0), text="Buy", textcolor=color.white, size=size.normal)
plotshape(sellSignal, "Sell Signal", shape.labeldown, location.abovebar, color.new(color.red, 0), text="Sell", textcolor=color.white, size=size.normal)
plotshape(executeBuy, "Execute", shape.labelup, location.belowbar, color.new(color.blue, 0), text="Execute", textcolor=color.white, size=size.tiny)
plotshape(executeSell, "Execute", shape.labeldown, location.abovebar, color.new(color.blue, 0), text="Execute", textcolor=color.white, size=size.tiny)

// Divergence Labels
if showDivergence and bullishDiv
    label.new(bar_index - pivotLookback, srcL[pivotLookback], "Higher Div", style=label.style_label_up, color=color.new(color.green, 30), textcolor=color.white, size=size.small)

if showDivergence and bearishDiv
    label.new(bar_index - pivotLookback, srcH[pivotLookback], "Lower Div", style=label.style_label_down, color=color.new(color.red, 30), textcolor=color.white, size=size.small)

// Trend Shift Labels
if showTrendShift and bullishTrendShift
    label.new(bar_index, srcL, "Trend Shift", style=label.style_label_up, color=color.new(color.aqua, 30), textcolor=color.white, size=size.small)

if showTrendShift and bearishTrendShift
    label.new(bar_index, srcH, "Trend Shift", style=label.style_label_down, color=color.new(color.purple, 30), textcolor=color.white, size=size.small)

// ==================== INDICATOR TABLE ====================
if showTable
    var table indicatorTable = table.new(position.top_right, 2, showParamsInTable ? 17 : 9, border_width=1)
    
    // Header
    table.cell(indicatorTable, 0, 0, "Indicator", bgcolor=color.new(color.gray, 50), text_color=color.white)
    table.cell(indicatorTable, 1, 0, "Signal", bgcolor=color.new(color.gray, 50), text_color=color.white)
    
    // Macro Trend
    macroColor = macroTrendBullish ? color.new(color.green, 70) : color.new(color.red, 70)
    macroText = macroTrendBullish ? "Bullish ▲" : "Bearish ▼"
    table.cell(indicatorTable, 0, 1, "Macro Trend", text_color=color.white)
    table.cell(indicatorTable, 1, 1, macroText, bgcolor=macroColor, text_color=color.white)
    
    // Current Timeframe
    currentColor = currentTrendBullish ? color.new(color.green, 70) : color.new(color.red, 70)
    currentText = currentTrendBullish ? "Bullish ▲" : "Bearish ▼"
    table.cell(indicatorTable, 0, 2, "Current Signal", text_color=color.white)
    table.cell(indicatorTable, 1, 2, currentText, bgcolor=currentColor, text_color=color.white)
    
    // Momentum
    momColor = momentumBullish ? color.new(color.green, 70) : color.new(color.red, 70)
    momText = momentumBullish ? "Bullish ▲" : "Bearish ▼"
    table.cell(indicatorTable, 0, 3, "Momentum", text_color=color.white)
    table.cell(indicatorTable, 1, 3, momText, bgcolor=momColor, text_color=color.white)
    
    // Market Structure
    structColor = structureBullish ? color.new(color.green, 70) : color.new(color.red, 70)
    structText = structureBullish ? "Bullish ▲" : "Bearish ▼"
    table.cell(indicatorTable, 0, 4, "Market Structure", text_color=color.white)
    table.cell(indicatorTable, 1, 4, structText, bgcolor=structColor, text_color=color.white)
    
    // Overbought/Oversold
    obosColor = oversold ? color.new(color.green, 70) : overbought ? color.new(color.red, 70) : color.new(color.gray, 70)
    obosText = oversold ? "Oversold" : overbought ? "Overbought" : "Neutral ⊖"
    table.cell(indicatorTable, 0, 5, "Overbought/Oversold", text_color=color.white)
    table.cell(indicatorTable, 1, 5, obosText, bgcolor=obosColor, text_color=color.white)
    
    volColor = volumeBullish ? color.new(color.green, 70) : color.new(color.red, 70)
    volText = volumeBullish ? "Bullish ▲" : "Bearish ▼"
    table.cell(indicatorTable, 0, 6, "Volume and Order Flow", text_color=color.white)
    table.cell(indicatorTable, 1, 6, volText, bgcolor=volColor, text_color=color.white)
    volStrColor = volumeStrength ? color.new(color.green, 70) : color.new(color.red, 70)
    volStrText = volumeStrength ? "Above Vol MA" : "Below Vol MA"
    table.cell(indicatorTable, 0, 7, "Volume Strength", text_color=color.white)
    table.cell(indicatorTable, 1, 7, volStrText, bgcolor=volStrColor, text_color=color.white)
    tsColor = trendStrength >= execTrendStrengthMin ? color.new(color.green, 70) : color.new(color.red, 70)
    tsText = trendStrength >= execTrendStrengthMin ? "Strong" : "Weak"
    table.cell(indicatorTable, 0, 8, "Trend Strength", text_color=color.white)
    table.cell(indicatorTable, 1, 8, tsText, bgcolor=tsColor, text_color=color.white)
    if showParamsInTable
        table.cell(indicatorTable, 0, 8, "Params", text_color=color.white)
        table.cell(indicatorTable, 1, 8, "TF: " + tf, bgcolor=color.new(color.gray, 70), text_color=color.white)
        table.cell(indicatorTable, 0, 9, "RSI Length", text_color=color.white)
        table.cell(indicatorTable, 1, 9, str.tostring(rsiLenEff), bgcolor=color.new(color.gray, 85), text_color=color.white)
        table.cell(indicatorTable, 0, 10, "MACD Fast", text_color=color.white)
        table.cell(indicatorTable, 1, 10, str.tostring(macdFastEff), bgcolor=color.new(color.gray, 85), text_color=color.white)
        table.cell(indicatorTable, 0, 11, "MACD Slow", text_color=color.white)
        table.cell(indicatorTable, 1, 11, str.tostring(macdSlowEff), bgcolor=color.new(color.gray, 85), text_color=color.white)
        table.cell(indicatorTable, 0, 12, "MACD Signal", text_color=color.white)
        table.cell(indicatorTable, 1, 12, str.tostring(macdSignalEff), bgcolor=color.new(color.gray, 85), text_color=color.white)
        table.cell(indicatorTable, 0, 13, "Fast MA", text_color=color.white)
        table.cell(indicatorTable, 1, 13, str.tostring(trendMA1Eff), bgcolor=color.new(color.gray, 85), text_color=color.white)
        table.cell(indicatorTable, 0, 14, "Slow MA", text_color=color.white)
        table.cell(indicatorTable, 1, 14, str.tostring(trendMA2Eff), bgcolor=color.new(color.gray, 85), text_color=color.white)
        table.cell(indicatorTable, 0, 15, "Momentum", text_color=color.white)
        table.cell(indicatorTable, 1, 15, str.tostring(momentumLengthEff), bgcolor=color.new(color.gray, 85), text_color=color.white)
        table.cell(indicatorTable, 0, 16, "Vol MA Len", text_color=color.white)
        table.cell(indicatorTable, 1, 16, str.tostring(volumeMAEff), bgcolor=color.new(color.gray, 85), text_color=color.white)

// ==================== ALERTS ====================
alertcondition(buySignal, "Buy Signal", "Multi-Confluence BUY Signal Generated!")
alertcondition(sellSignal, "Sell Signal", "Multi-Confluence SELL Signal Generated!")
alertcondition(bullishDiv, "Bullish Divergence", "Bullish Divergence Detected!")
alertcondition(bearishDiv, "Bearish Divergence", "Bearish Divergence Detected!")
alertcondition(bullishTrendShift, "Bullish Trend Shift", "Bullish Trend Shift Detected!")
alertcondition(bearishTrendShift, "Bearish Trend Shift", "Bearish Trend Shift Detected!")
alertcondition(executeBuy, "Execute Buy", "Execute BUY Triggered")
alertcondition(executeSell, "Execute Sell", "Execute SELL Triggered")
