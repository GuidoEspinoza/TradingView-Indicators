//@version=6
indicator("Professional Institutional VWAP", shorttitle="Inst. VWAP", overlay=true)

// ==================== CONFIGURACIÓN ====================
group_main = "Configuración Principal"
showBands = input.bool(true, "Mostrar Bandas de Desviación", group=group_main)
stdevMult = input.float(1.5, "Multiplicador de Desviación", step=0.1, group=group_main)
anchorPeriod = input.string("Session", "Periodo de Anclaje", options=["Session", "Week", "Month"], group=group_main)

group_vis = "Colores"
colorUp = input.color(color.new(color.green, 0), "Tendencia Alcista", group=group_vis)
colorDown = input.color(color.new(color.red, 0), "Tendencia Bajista", group=group_vis)
bandColor = input.color(color.new(color.gray, 80), "Color de Bandas", group=group_vis)

// ==================== CÁLCULOS ====================
// Detectar inicio de nuevo periodo
startPeriod = switch anchorPeriod
    "Session" => timeframe.change("D")
    "Week" => timeframe.change("W")
    "Month" => timeframe.change("M")
    => false

// Acumuladores
var float sumSrcVol = 0.0
var float sumVol = 0.0
var float sumSrcSrcVol = 0.0 // Para cálculo de desviación estándar

if startPeriod
    sumSrcVol := 0.0
    sumVol := 0.0
    sumSrcSrcVol := 0.0

// Cálculo VWAP
src = hlc3
vol = volume

sumSrcVol += src * vol
sumVol += vol
sumSrcSrcVol += vol * math.pow(src, 2)

vwapValue = sumSrcVol / sumVol

// Cálculo Desviación Estándar
variance = sumSrcSrcVol / sumVol - math.pow(vwapValue, 2)
stdev = math.sqrt(math.max(variance, 0))

upperBand = vwapValue + stdev * stdevMult
lowerBand = vwapValue - stdev * stdevMult

// ==================== TENDENCIA ====================
trend = close > vwapValue ? 1 : -1
plotColor = trend == 1 ? colorUp : colorDown

// ==================== VISUALIZACIÓN ====================
// Línea VWAP Principal
plot(vwapValue, "VWAP", color=plotColor, linewidth=2)

// Bandas
p1 = plot(showBands ? upperBand : na, "Upper Band", color=bandColor)
p2 = plot(showBands ? lowerBand : na, "Lower Band", color=bandColor)
fill(p1, p2, color=color.new(plotColor, 95), title="Zona de Valor")

// ==================== ETIQUETAS ====================
var label vwapLabel = na
if barstate.islast
    label.delete(vwapLabel)
    vwapLabel := label.new(x=bar_index + 5, y=vwapValue, text="VWAP " + str.tostring(math.round_to_mintick(vwapValue)), color=plotColor, textcolor=color.white, style=label.style_label_left, size=size.small)

// ==================== ALERTAS ====================
alertcondition(ta.crossover(close, vwapValue), "VWAP Cross Over", "Precio cruzó VWAP hacia arriba")
alertcondition(ta.crossunder(close, vwapValue), "VWAP Cross Under", "Precio cruzó VWAP hacia abajo")
