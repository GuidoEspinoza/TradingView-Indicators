//@version=6
indicator("Professional Relative Volume (RVOL)", shorttitle="Pro RVOL", format=format.volume)

// ==================== CONFIGURACIÓN ====================
length = input.int(20, "Periodo de Comparación (Días)", minval=1)
maLength = input.int(20, "Media Móvil de Volumen", minval=1)
thresholdUltra = input.float(2.5, "Umbral Ultra Alto (x)", step=0.1)
thresholdHigh = input.float(1.2, "Umbral Alto (x)", step=0.1)
thresholdLow = input.float(0.5, "Umbral Bajo (x)", step=0.1)

// ==================== CÁLCULOS ====================
// RVOL Intradía: Compara la vela actual con la media de la misma hora en días pasados
// Esto requiere lógica compleja de arrays para guardar volumen por hora

// Simplificación Robusta para Intradía:
// Compara volumen actual vs SMA de volumen
volSMA = ta.sma(volume, maLength)
rvol = volume / volSMA

// ==================== COLORES ====================
rvolColor = rvol >= thresholdUltra ? color.new(color.yellow, 0) : rvol >= thresholdHigh ? color.new(color.green, 0) : rvol <= thresholdLow ? color.new(color.purple, 0) : color.new(color.gray, 50)

// ==================== VISUALIZACIÓN ====================
plot(rvol, "RVOL Ratio", color=rvolColor, style=plot.style_columns, linewidth=2)
hline(1.0, "Media Normal", color=color.gray, linestyle=hline.style_dotted)
hline(thresholdHigh, "Alto", color=color.green, linestyle=hline.style_dashed)
hline(thresholdUltra, "Ultra", color=color.yellow, linestyle=hline.style_dashed)

// Media móvil del propio RVOL para ver tendencia de volumen
plot(ta.sma(rvol, 10), "SMA RVOL", color=color.white, linewidth=1)

// ==================== ETIQUETA DE ESTADO ====================
var label statusLabel = na
if barstate.islast
    label.delete(statusLabel)
    statusText = "RVOL: " + str.tostring(rvol, "#.##") + "x"
    statusColor = rvol >= thresholdHigh ? color.green : color.gray
    statusLabel := label.new(x=bar_index + 1, y=rvol, text=statusText, color=statusColor, textcolor=color.white, style=label.style_label_left, size=size.small)

// ==================== ALERTAS ====================
alertcondition(rvol > thresholdUltra, "Ultra High Volume", "Volumen Explosivo Detectado (> 2.5x)")
alertcondition(rvol > thresholdHigh, "High Volume", "Volumen Alto Detectado (> 1.2x)")
